<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>完成</title>
<link rel="stylesheet" href="../assets/css/style.css"/>

<style>
  .player-info{
    margin-top:6px;
    font-size:13px;
    color:#64748b;
    display:flex;
    flex-wrap:wrap;
    gap:12px;
  }
  .player-info span{
    white-space:nowrap;
  }

  /* Loading 緩衝畫面 */
  .loading-overlay{
    position:fixed;
    inset:0;
    background:#ffffff;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .loading-overlay.active{
    display:flex;
  }
  .loading-box{
    text-align:center;
  }
  .loading-box img{
    width:120px;
    max-width:40vw;
    height:auto;
    display:block;
    margin:0 auto 12px;
  }
  .loading-box p{
    margin:0;
    font-size:16px;
    color:#374151;
  }
</style>

<script type="module">
import { initProgress } from "../assets/js/app.js";
window.addEventListener("DOMContentLoaded", () => initProgress("完成"));
</script>
</head>
<body>
  <div class="container">
    <header>
      <h1>完成</h1>
      <div class="player-info">
        <span id="playerSid">學號：——</span>
        <span id="playerName">姓名：——</span>
      </div>
    </header>

    <div class="progress-block">
      <div class="pbar-labels" id="pbar-labels"></div>
      <div class="pbar"><span id="pbar-fill"></span></div>
    </div>

    <main class="card">
      <h2>完成</h2>
      <p>恭喜！你已完成三大任務。若得分達 100 分，即可取得圖書館認證。</p>
      <p class="notice">若需修改作答，可回到各任務頁重做。關閉瀏覽器不會清除資料。</p>
      <div class="button-row">
        <a class="button" href="../index.html" id="btnFinishBack">回首頁</a>
      </div>
    </main>

    <div class="footer">© 2025 Fu Jen Library · FJU Freshman Adventure</div>
  </div>

  <!-- Loading 緩衝畫面 -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-box">
      <img src="../icon/Universal/loading.png" alt="載入中"/>
      <p>加載中，請稍後…</p>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbysBKsv9n7471wj3sAWFpa1MI85JesJJJwhhopzWwIt4GUAa-ITQKWITqEhJcdMMi3nXA/exec";

    // 顯示學號 / 姓名
    (function(){
      const sid  = localStorage.getItem('player_sid')  || localStorage.getItem('home_sid')  || '';
      const name = localStorage.getItem('player_name') || localStorage.getItem('home_name') || '';
      const sidEl  = document.getElementById('playerSid');
      const nameEl = document.getElementById('playerName');
      if(sidEl){
        sidEl.textContent = '學號：' + (sid || '未登入');
      }
      if(nameEl){
        nameEl.textContent = '姓名：' + (name || '未登入');
      }
    })();

    function showLoadingOverlay(){
      const el = document.getElementById('loadingOverlay');
      if(el) el.classList.add('active');
    }

    // 完成 → 回傳 finish = pass
    async function notifyFinishPassToServer(){
      const sid  = localStorage.getItem('player_sid')  || localStorage.getItem('home_sid')  || '';
      const name = localStorage.getItem('player_name') || localStorage.getItem('home_name') || '';
      if (!sid || !name) return;

      try{
        await fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors', // 簡單請求，不讀回應，避免 CORS
          body: JSON.stringify({
            action: 'updateProgress',
            sid,
            name,
            mission: 'finish',
            value: 'pass'
          })
        });

        // 視為已送出，記一個旗標
        localStorage.setItem('finish_from_sheet', 'pass');
      }catch(e){
        console.error('notifyFinishPassToServer error', e);
      }
    }

    // 按「回首頁」時才打 finish = pass
    (function(){
      const btnFinish = document.getElementById('btnFinishBack');
      if(!btnFinish) return;

      btnFinish.addEventListener('click', async (e)=>{
        e.preventDefault();
        showLoadingOverlay();
        await notifyFinishPassToServer();
        location.href = '../index.html';
      });
    })();
  </script>
</body>
</html>
